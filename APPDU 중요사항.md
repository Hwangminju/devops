#### 1. 재택/회사 근무 ip 설정 변경

[업무용 PC - 재택근무]

- 고정ip => 유동ip
- DNS 서버 : 168.126.63.1 / 168.126.63.2
- 네트워크 설정 - 구성 탭 - 802.11a/b/g 무선모드 => 듀얼밴드 802.11a/b/g
- SSID_KT 자동할당으로 변경

[업무용 PC - 회사근무]

- 고정ip : 10.214.145.77
- 서브넷 마스크 : 255.255.254.0
- 기본 게이트웨이 : 10.214.144.1
- DNS 서버 : 147.6.44.44 / 147.6.44.45



#### 2. pip install 시 SSL 에러 발생 해결

pip install sphinx_rtd_theme --trusted-host pypi.python.org --trusted-host files.pythonhosted.org --trusted-host pypi.org 

또는

[pip.ini 생성/설정]

- C:\Users\{계정명}\AppData\Roaming\pip\pip.ini

- AppData\Roaming은 숨김폴더로 되어 있음
- pip폴더 생성 후 pip.ini 파일 생성



#### 3. git clone 인증실패 떴을 때, 다시 인증창 생기게 하는 명령어

$ git config --system --unset credential.helper



#### 4. python json & string 변환

json. loads() takes in a string and returns a json object.
json. dumps() takes in a json object and returns a string.



#### 5. sts 설치 파일 경로

http://git.cz-dev.container.kt.co.kr/arsenal-suite/arsenal-docs/utils/-/tree/master/STS



#### 6. outlook 로그인 계정

[appdu 사업용 계정 outlook]

corp\biz215143 & pw_biz215143_!

[개인 계정 outlook]

corp\10151080 & 비밀번호



#### 7. appdu 시스템 로그인 계정

개발 jenkins

- admin / P@ssw0rd

운영 jenkins

- root / P@ssw0rd

Nexus

- admin/ Admin123

Openshift

- admin / New1234!



#### 8. nexus에서 pip 라이브러리 못 받아올 때 (인증서 만료 이슈)

- SSL Certificates에서 Load certificate
- files.pythonhosted.org (Load from Server)



#### 9. vue script 함수들

- computed
- watch



#### 10. 인프라 셋팅 (DMZ 존) - appdu-novaocean 참고

- 사내 nexus 서버가 외부 라이브러리를 제대로 받아오지 못할 때
  1. 박지선S에게 appdu-childern=true 레이블 삭제 요청
  2. jenkins/dockerize.groovy 파일에서 appdu-childern=true 레이블 삭제
  3. appdu-dmz-childern=true 레이블 추가 => jenkins-slave 파드가 dmz 존에 뜨게 됨
- 단, 개발 pod가 dmz 존에 안 뜨게 하려면
  - helm/value.yaml에 nodeSelector에 appdu-childern=true 레이블 추가



#### 11. 중복된 포트 이슈 (사용 중인 포트입니다 에러)

**[현황] appdu-demo9 환경에 새롭게 셋팅을 했으나, 40109 포트가 사용중이라는 에러가 발생**

http://adminer-appdu.cz-okd-prd.arsenal.kt.co.kr/?server=cz2-okd-prd-portal-backend-prd-deploy-mariadb&username=root&db=appdu

- ad_auto_env_info 테이블에서 appdu-demo9 확인 ~> 개발환경은 삭제되었으므로 존재X

- auto_env_containerized_db_info에서 해당 row 삭제
  - host_port = 40109 검색 ~> row 삭제



#### 12. Docker Desktop 설치

- https://www.lainyzine.com/ko/article/a-complete-guide-to-how-to-install-docker-desktop-on-windows-10/
- https://github.com/docker/for-win/issues/9972



#### 13. 로컬 ~ 도커 컨테이너 간에 파일 복사

###### # 로컬의 파일을 컨테이너 안으로 복사

로컬의 “~/data/test.md” 라는 파일을 컨테이너의 “/root/data/”로 복사

```shell
$ docker cp ~/data/test.md tmp_container:/root/data/
```

###### # 컨테이너에서 로컬로 파일 복사

```shell
$ kubectl cp giga-doctor-prd-deploy-mariadb-0:/tmp/dump_gc.sql /mnt/d
```



#### 14. APM agent 적용 이미지 목록 (PHP/Java)

```shell
# PHP
ktis-bastion01.container.ipc.kt.com:5000/admin/php-apm:7.2-apache-v1.1
# PHP laravel
ktis-bastion01.container.ipc.kt.com:5000/admin/php8-apm-laravel-nginx-fpm-1.20.1:1.1
```



#### 15.  APM agent 셋팅 (PHP)

- ##### bastion 서버에 있는 베이스 이미지 목록 조회

  https://ktis-bastion01.container.ipc.kt.com:5000/v2/_catalog?n=100000 

  (get으로 호출)

  

##### 1) docker 이미지 pull & 컨테이너 실행

```shell
# 1. ktis-bastion01.container.ipc.kt.com:5000/arsenal/php:7.2-fpm-nginx-v1.0 이미지 pull
# 2. php-apm라는 이름의 컨테이너로 실행(sh)
$ docker run -it --name php-apm ktis-bastion01.container.ipc.kt.com:5000/arsenal/php:7.2-fpm-nginx-v1.0 sh
```

##### 2) exited된 컨테이너일 경우 다시 실행하는 방법

```shell
$ docker restart php-apm
$ docker exec -it php-apm sh
```

##### 3) 컨테이너 접속 후 필요한 경우에 설치

```
# apt update
# apt install git
```



**3-1) Elastic APM agent docs에서 deb 파일 다운 후, 컨테이너에 복사**

```shell
$ dpkg -i apm-agent-php_1.3.1_all.deb

# php 설치 모듈 리스트 출력 => elastic_apm 확인
$ php -m
```

```sh
# dpkg -i apm-agent-php_1.3.1_all.deb

Selecting previously unselected package apm-agent-php.
(Reading database ... 24441 files and directories currently installed.)
Preparing to unpack apm-agent-php_1.3.1_all.deb ...
Unpacking apm-agent-php (1.3.1) ...
Setting up apm-agent-php (1.3.1) ...
Installing Elastic PHP agent
DEBUG: after-install parameter is 'configure'
Detected PHP version '8.0'
Creating /opt/elastic/apm-agent-php/etc/elastic-apm.ini
; ***** DO NOT EDIT THIS FILE *****
; THIS IS AN AUTO-GENERATED FILE by the Elastic PHP agent post-install.sh script
; To overwrite the INI settings for this extension, edit
; the INI file in this directory "/opt/elastic/apm-agent-php/etc/elastic-apm-custom.ini"

[elastic]
extension=/opt/elastic/apm-agent-php/extensions/elastic_apm-20200930.so
elastic_apm.bootstrap_php_part_file=/opt/elastic/apm-agent-php/src/bootstrap_php_part.php
; END OF AUTO-GENERATED by the Elastic PHP agent post-install.sh script
/opt/elastic/apm-agent-php/etc/elastic-apm.ini created
Configuring elastic-apm.ini for supported SAPI's
Found SAPI config directory: /usr/local/etc/php/conf.d

Linking /opt/elastic/apm-agent-php/etc/elastic-apm.ini to /usr/local/etc/php/conf.d/98-elastic-apm.ini
Linking /opt/elastic/apm-agent-php/etc/elastic-apm-custom.ini to /usr/local/etc/php/conf.d/99-elastic-apm-custom.ini

Extension enabled successfully for Elastic PHP agent
```

- agent 메인 셋팅 파일: ***/opt/elastic/apm-agent-php/etc/elastic-apm-custom.ini***

- secret_token: ***e77061bb3aaedae5ae8dd0ca193eb662513aedde***



**3-2) 송양종 차장님 방법 (composer)**

```
# echo insecure >> ~/.curlrc
# curl -sS https://getcomposer.org/installer -o composer-setup.php

# HASH=`curl -sS https://composer.github.io/installer.sig`
# echo $HASH
906a84df04cea2aa72f40b5f787e49f22d4c2f19492ac310e8cba5b96ac8b64115ac402c8cd292b8a03482574915d1a8

# php -r "if (hash_file('SHA384', 'composer-setup.php') === '$HASH') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
Installer verified

# php composer-setup.php --install-dir=/usr/local/bin --filename=composer --disable-tls
All settings correct for using Composer
Downloading...

Composer (version 2.2.1) successfully installed to: /usr/local/bin/composer
Use it: php /usr/local/bin/composer

You have instructed the Installer not to enforce SSL/TLS security on remote HTTPS requests.
This will leave all downloads during installation vulnerable to Man-In-The-Middle (MITM) attacks

# composer config -g repo.packagist composer http://packagist.org (cURL 60 에러)
# composer config --global --auth github-oauth.github.com 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
```

> github access token : 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

```
git clone 시에 CAfile 관련 에러

[RuntimeException]
Failed to execute git clone --mirror -- 'https://ghp...uCi:x-oauth-basic@github.com/firebase/php-jwt.git' '/root/.composer/cache/vcs/https---github.com-firebase-php-jwt.git/'

Cloning into bare repository '/root/.composer/cache/vcs/https---github.com-firebase-php-jwt.git'...
fatal: unable to access 'https://ghp...uCi:x-oauth-basic@github.com/firebase/php-jwt.git/': server certificate verification failed. CAfile: none CRLfile: none

~> # git config --global http.sslVerify false

# composer require firebase/php-jwt 
# composer require philkra/elastic-apm-php-agent
```

php 컨테이너 내 nginx 폴더 : **/etc/nginx**



##### 4) docker image commit (로컬 레지스트리)

```shell
$ docker commit php-apm php-apm:7.2-fpm-nginx-v1.0
```

##### 5) docker image tagging (로컬 레지스트리)

```shell
$ docker tag php-apm:7.2-fpm-nginx-v1.0 ktis-bastion01.container.ipc.kt.com:5000/arsenal/php-apm:7.2-fpm-nginx-v1.0
```

```shell
$ docker images
REPOSITORY                                                 TAG                  IMAGE ID       CREATED        SIZE
php-apm                                                    7.2-fpm-nginx-v1.0   05e65351e9b2   4 hours ago    643MB
ktis-bastion01.container.ipc.kt.com:5000/arsenal/php-apm   7.2-fpm-nginx-v1.0   05e65351e9b2   4 hours ago    643MB
ktis-bastion01.container.ipc.kt.com:5000/arsenal/php       7.2-fpm-nginx-v1.0   df10dbf5388c   4 months ago   620MB
```

##### 6) docker image push (클러스터 비즈니스 이미지 레지스트리)

```shell
$ docker push ktis-bastion01.container.ipc.kt.com:5000/arsenal/php-apm:7.2-fpm-nginx-v1.0
```

```shell
The push refers to repository [ktis-bastion01.container.ipc.kt.com:5000/arsenal/php-apm]
fd1920114e7d: Pushed
6debcc2e3d54: Mounted from arsenal/php
bc7ce6357b22: Mounted from arsenal/php
47003bc5e131: Mounted from arsenal/php
70c4d730b083: Mounted from arsenal/php
9c60a520fbc2: Mounted from arsenal/php
197778d10010: Mounted from arsenal/php
b65c3076245b: Mounted from arsenal/php
5dfc40c1b4dd: Mounted from arsenal/php
02eef72b445f: Mounted from arsenal/php
e45a78df7536: Mounted from arsenal/php
ddcd8d2fcf7e: Mounted from arsenal/php
87c8a1d8f54f: Mounted from arsenal/php
7.2-fpm-nginx-v1.0: digest: sha256:1ab656c70e8045d8ca15578a462bf47cf83b69ff9c3a9c1bc06ba21927921970 size: 3041
```

- GET https://ktis-bastion01.container.ipc.kt.com:5000/v2/_catalog?n=100000

  => 결과 리스트에 "arsenal/php-apm"가 추가된 것을 확인할 수 있다.



- php.ini 파일, 99-elastic-apm-custom.ini 파일 위치 : **/usr/local/etc/php/conf.d**

- elastic-apm-custom.ini 파일 위치

  **/opt/elastic/apm-agent-php/etc**
  
- elastic-apm-custom.ini 파일 수정 내용

  [elastic]
  elastic_apm.enabled = true
  elastic_apm.environment = "production" 또는 "dev"
  elastic_apm.log_level = "INFO"
  elastic_apm.log_level_stderr = "INFO"
  elastic_apm.secret_token = "e77061bb3aaedae5ae8dd0ca193eb662513aedde"
  elastic_apm.server_url = "http://apm-server-apm-server.appdu-monitoring:8200"
  elastic_apm.service_name = "namespace__name"

![image-20220102104451664](D:\10151080\2. Appdu\0. 중요사항\5. 개인 업무\php-apm-test.png)



#### 16.  APM agent 셋팅 (java)

1) 베이스 이미지 run

```
PS D:\> docker run -it --name java-apm ktis-bastion01.container.ipc.kt.com:5000/alpine/openjdk-8:latest sh
```

2) agent 셋팅

https://www.elastic.co/guide/en/apm/agent/java/current/setup-attach-cli.html 참고

```
PS D:\> docker cp elastic-apm-agent-1.28.4.jar java-apm:/home/appuser

PS D:\> docker restart java-apm
java-apm

PS D:\> docker exec -it java-apm sh
~ $ ls
elastic-apm-agent-1.28.4.jar

~ $ java -jar elastic-apm-agent-1.28.4.jar \
> --include-main JavaBackendApplication \
> --include-all \
> --continuous \
> --config service_name=appdu-demo5__backend-java \
> --config server_url=http://apm-server-apm-server.appdu-monitoring:8200 \
> --config secret_token=e77061bb3aaedae5ae8dd0ca193eb662513aedde
{"@timestamp":"2022-01-06T12:30:40.835Z", "log.level":"ERROR", "message":"Cannot find agent jar. When using the slim jar, either the --agent-jar or the --download-agent-version arguments are required", "ecs.version": "1.2.0","service.name":"java-attacher","event.dataset":"java-attacher.log","process.thread.name":"main","log.logger":"co.elastic.apm.attach.AgentAttacher"}
```

3) docker image 생성 및 push

```
PS D:\> docker commit java-apm openjdk-8-apm
sha256:d7ff97266fbf42bbe1ae56adc4e287e2a85978616b8d2f23fa7e198d8f1cb838

PS D:\> docker images
REPOSITORY                                                  TAG                  IMAGE ID       CREATED         SIZE
openjdk-8-apm                                               latest               d7ff97266fbf   8 seconds ago   139MB
php-apm                                                     7.2-fpm-nginx-v1.0   5ed23e69adeb   3 days ago      712MB
ktis-bastion01.container.ipc.kt.com:5000/arsenal/php-apm    7.2-fpm-nginx-v1.0   5ed23e69adeb   3 days ago      712MB
ktis-bastion01.container.ipc.kt.com:5000/arsenal/php        7.2-fpm-nginx-v1.0   df10dbf5388c   5 months ago    620MB
ktis-bastion01.container.ipc.kt.com:5000/alpine/openjdk-8   latest               50e37d990972   2 years ago     104MB

PS D:\> docker tag openjdk-8-apm:latest ktis-bastion01.container.ipc.kt.com:5000/alpine/openjdk-8-apm:latest

PS D:\> docker push ktis-bastion01.container.ipc.kt.com:5000/alpine/openjdk-8-apm:latest
The push refers to repository [ktis-bastion01.container.ipc.kt.com:5000/alpine/openjdk-8-apm]
dba814cff08b: Pushed
d72cbb78b629: Mounted from alpine/openjdk-8
72093e822c63: Mounted from alpine/openjdk-8
4789207af511: Mounted from alpine/openjdk-8
721384ec99e5: Mounted from alpine/openjdk-8
latest: digest: sha256:c3036fa0c5b79f87d195f7a5ca1f76860ae038f0b7a9beb88032a940647c100e size: 1367
```



#### 17. ElasticSearch 데이터 확인

```
curl -XPOST 'elasticsearch-apm.dev.appdu.kt.co.kr:80/apm-7.11.1-transaction-000003/_search?size=0&pretty' \
--header 'Content-Type: application/json' \
--data-raw '
{
    "query": {
        "bool": {
        	"must": {
            	"query_string": {
             		"query": "*",
             		"default_operator": "OR",
             		"fields": [
             			"service.name"
             		]
             	}
            },
            "filter": {
                "range": {
                    "@timestamp": {
                        "gte": "2022-01-20T00:00:00.000Z",
                        "lt": "2022-01-20T09:59:59.999Z"
                    }
                }
            }
        }
    },
    "size": 0,
    "aggs": {
        "perdate": {
            "date_histogram": {
                "field": "@timestamp",
                "calendar_interval": "hour",
                "format": "yyyyMMddHH",
                "time_zone": "+09:00"
            },
            "aggs": {
                "service_stats": {
                    "terms": {
                        "field": "service.name"
                    },
                    "aggs": {
                        "url": {
                            "terms": {
                                "field": "url.path"
                            },
                            "aggs": {
                                "method": {
                                    "terms": {
                                        "field": "http.request.method"
                                    },
                                    "aggs": {
                                        "status_code": {
                                            "terms": {
                                                "field": "http.response.status_code"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}'
```

위 명령어로 apm-7.11.1-transaction-000001 인덱스에 쌓인 데이터를 전부 json 형식으로 출력 가능!

[결과]

```
{
  "took" : 3,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2880,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "perdate" : {
      "buckets" : [
        {
          "key_as_string" : "2021121801",
          "key" : 1639756800000,
          "doc_count" : 960,
          "service_stats" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "appdu-q-planner__backend-express",
                "doc_count" : 480,
                "url" : {
                  "doc_count_error_upper_bound" : 0,
                  "sum_other_doc_count" : 0,
                  "buckets" : [
                    {
                      "key" : "/",
                      "doc_count" : 480,
                      "method" : {
                        "doc_count_error_upper_bound" : 0,
                        "sum_other_doc_count" : 0,
                        "buckets" : [
                          {
                            "key" : "GET",
                            "doc_count" : 480,
                            "status_code" : {
                              "doc_count_error_upper_bound" : 0,
                              "sum_other_doc_count" : 0,
                              "buckets" : [
                                {
                                  "key" : 200,
                                  "doc_count" : 480
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "key" : "appdu1__backend-express",
                "doc_count" : 480,
                "url" : {
                  "doc_count_error_upper_bound" : 0,
                  "sum_other_doc_count" : 0,
                  "buckets" : [
                    {
                      "key" : "/",
                      "doc_count" : 480,
                      "method" : {
                        "doc_count_error_upper_bound" : 0,
                        "sum_other_doc_count" : 0,
                        "buckets" : [
                          {
                            "key" : "GET",
                            "doc_count" : 480,
                            "status_code" : {
                              "doc_count_error_upper_bound" : 0,
                              "sum_other_doc_count" : 0,
                              "buckets" : [
                                {
                                  "key" : 200,
                                  "doc_count" : 480
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "key_as_string" : "2021121802",
          "key" : 1639760400000,
          "doc_count" : 960,
          "service_stats" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "appdu-q-planner__backend-express",
                "doc_count" : 480,
                "url" : {
                  "doc_count_error_upper_bound" : 0,
                  "sum_other_doc_count" : 0,
                  "buckets" : [
                    {
                      "key" : "/",
                      "doc_count" : 480,
                      "method" : {
                        "doc_count_error_upper_bound" : 0,
                        "sum_other_doc_count" : 0,
                        "buckets" : [
                          {
                            "key" : "GET",
                            "doc_count" : 480,
                            "status_code" : {
                              "doc_count_error_upper_bound" : 0,
                              "sum_other_doc_count" : 0,
                              "buckets" : [
                                {
                                  "key" : 200,
                                  "doc_count" : 480
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "key" : "appdu1__backend-express",
                "doc_count" : 480,
                "url" : {
                  "doc_count_error_upper_bound" : 0,
                  "sum_other_doc_count" : 0,
                  "buckets" : [
                    {
                      "key" : "/",
                      "doc_count" : 480,
                      "method" : {
                        "doc_count_error_upper_bound" : 0,
                        "sum_other_doc_count" : 0,
                        "buckets" : [
                          {
                            "key" : "GET",
                            "doc_count" : 480,
                            "status_code" : {
                              "doc_count_error_upper_bound" : 0,
                              "sum_other_doc_count" : 0,
                              "buckets" : [
                                {
                                  "key" : 200,
                                  "doc_count" : 480
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "key_as_string" : "2021121803",
          "key" : 1639764000000,
          "doc_count" : 960,
          "service_stats" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : "appdu-q-planner__backend-express",
                "doc_count" : 480,
                "url" : {
                  "doc_count_error_upper_bound" : 0,
                  "sum_other_doc_count" : 0,
                  "buckets" : [
                    {
                      "key" : "/",
                      "doc_count" : 480,
                      "method" : {
                        "doc_count_error_upper_bound" : 0,
                        "sum_other_doc_count" : 0,
                        "buckets" : [
                          {
                            "key" : "GET",
                            "doc_count" : 480,
                            "status_code" : {
                              "doc_count_error_upper_bound" : 0,
                              "sum_other_doc_count" : 0,
                              "buckets" : [
                                {
                                  "key" : 200,
                                  "doc_count" : 480
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "key" : "appdu1__backend-express",
                "doc_count" : 480,
                "url" : {
                  "doc_count_error_upper_bound" : 0,
                  "sum_other_doc_count" : 0,
                  "buckets" : [
                    {
                      "key" : "/",
                      "doc_count" : 480,
                      "method" : {
                        "doc_count_error_upper_bound" : 0,
                        "sum_other_doc_count" : 0,
                        "buckets" : [
                          {
                            "key" : "GET",
                            "doc_count" : 480,
                            "status_code" : {
                              "doc_count_error_upper_bound" : 0,
                              "sum_other_doc_count" : 0,
                              "buckets" : [
                                {
                                  "key" : 200,
                                  "doc_count" : 480
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              }
            ]
          }
        }
      ]
    }
  }
}
```

- 모든 document 조회하기

```
curl -XGET 'localhost:9200/apm-7.11.1-transaction-000003/_search?pretty'
```

```
{
        "_index" : "apm-7.11.1-transaction-000003",
        "_type" : "_doc",
        "_id" : "yRsS8H0B4spsxcIvc4r5",
        "_score" : 1.0,
        "_source" : {
          "container" : {
            "id" : "b0f0756b13baa7610bb6032a20485b2bc567513cdf55ba02d8429e154b89603b"
          },
          "kubernetes" : {
            "pod" : {
              "uid" : "ceaacf32-4070-11ec-a704-fa163e640a09",
              "name" : "backend-express-869bd685fd-wfctn"
            }
          },
          "agent" : {
            "name" : "nodejs",
            "version" : "3.23.0"
          },
          "process" : {
            "args" : [
              "/usr/local/bin/node",
              "/usr/src/app/bin/www"
            ],
            "pid" : 19,
            "title" : "node",
            "ppid" : 1
          },
          "source" : {
            "ip" : "192.168.194.1"
          },
          "processor" : {
            "name" : "transaction",
            "event" : "transaction"
          },
          "url" : {
            "path" : "/",
            "original" : "/",
            "scheme" : "http",
            "port" : 3000,
            "domain" : "192.168.194.206",
            "full" : "http://192.168.194.206:3000/"
          },
          "observer" : {
            "hostname" : "apm-server-apm-server-6765884489-vtpfk",
            "id" : "c2666c34-5a18-4a01-9e66-adb0225cc6e4",
            "ephemeral_id" : "87a18071-8f1e-4d58-9484-5c8e569bc370",
            "type" : "apm-server",
            "version" : "7.11.1",
            "version_major" : 7
          },
          "trace" : {
            "id" : "b16d8ed9ffcfb93e744c46965b9b1723"
          },
          "@timestamp" : "2021-12-25T05:31:11.877Z",
          "ecs" : {
            "version" : "1.6.0"
          },
          "service" : {
            "node" : {
              "name" : "b0f0756b13baa7610bb6032a20485b2bc567513cdf55ba02d8429e154b89603b"
            },
            "environment" : "production",
            "framework" : {
              "name" : "express",
              "version" : "4.16.4"
            },
            "name" : "appdu1__backend-express",
            "runtime" : {
              "name" : "node",
              "version" : "12.13.0"
            },
            "language" : {
              "name" : "javascript"
            },
            "version" : "1.0.0"
          },
          "host" : {
            "os" : {
              "platform" : "linux"
            },
            "ip" : "192.168.194.206",
            "architecture" : "x64"
          },
          "http" : {
            "request" : {
              "headers" : {
                "User-Agent" : [
                  "kube-probe/1.11+"
                ],
                "Connection" : [
                  "close"
                ],
                "Host" : [
                  "192.168.194.206:3000"
                ],
                "Accept-Encoding" : [
                  "gzip"
                ]
              },
              "method" : "GET",
              "socket" : {
                "encrypted" : false,
                "remote_address" : "::ffff:192.168.194.1"
              }
            },
            "response" : {
              "headers" : {
                "Etag" : [
                  "W/\"125-LR0sEx6uRoTV4E+CstYC1fgBkJU\""
                ],
                "Access-Control-Allow-Origin" : [
                  "*"
                ],
                "Connection" : [
                  "close"
                ],
                "Content-Length" : [
                  "293"
                ],
                "Date" : [
                  "Sat, 25 Dec 2021 05:31:11 GMT"
                ],
                "X-Powered-By" : [
                  "Express"
                ],
                "Content-Type" : [
                  "text/html; charset=utf-8"
                ]
              },
              "status_code" : 200
            },
            "version" : "1.1"
          },
          "client" : {
            "ip" : "192.168.194.1"
          },
          "event" : {
            "ingested" : "2021-12-25T05:31:20.953000778Z",
            "outcome" : "success"
          },
          "transaction" : {
            "duration" : {
              "us" : 4739
            },
            "result" : "HTTP 2xx",
            "name" : "GET /",
            "id" : "c134304a15a10b1a",
            "span_count" : {
              "started" : 2
            },
            "type" : "request",
            "sampled" : true
          },
          "user_agent" : {
            "original" : "kube-probe/1.11+",
            "name" : "Other",
            "device" : {
              "name" : "Other"
            }
          },
          "timestamp" : {
            "us" : 1640410271877003
          }
}
```

- 특정 언어만 조회하기

```
curl -XPOST 'elasticsearch-apm.dev.appdu.kt.co.kr:80/apm-7.11.1-transaction-000003/_search?size=0&pretty' \
--header 'Content-Type: application/json' \
--data-raw '
{
  "query": {
    "match": {
      "agent.name": "php"
    }
  },
  "aggs": {
    "response": {
      "terms": {
      	"field": "http.response.status_code"
      }
    }
  }
}'
```



#### 18. 운영 전환 셋팅

1) 운영 환경 작업공간 요청 (인프라)

2) 작업공간 할당 및 사용자 추가

3) DB 접속 Service - metadata 이름 빠진 부분 넣기

4) 빌드 - 배포

5) 사외망 오픈 시 SSL 설정



#### 19. 오류 발생 시 helm 삭제 방법

```
❯ helm list
```

|            NAME            | REVISION |         UPDATED          |  STATUS  |              CHART               | APP VERSION |    NAMESPACE    |
| :------------------------: | :------: | :----------------------: | :------: | :------------------------------: | :---------: | :-------------: |
| appdu-novaocean-dev-deploy |    35    | Mon Jan 10 15:32:12 2022 | DEPLOYED | appdu-novaocean-dev-deploy-0.1.0 |     1.0     | appdu-novaocean |



작업공간 초기화 메뉴가 제대로 작동 안 할때 수동으로 초기화하는 방법

1. helm delete
2. tiller delete



##### 1) helm delete 명령어

```
❯ helm delete --tiller-namespace appdu-novaocean --purge appdu-novaocean-dev-deploy

release "appdu-novaocean-dev-deploy" deleted
```

우리가 작업공간 초기화 메뉴를 하게 되면 위 명령어가 수행되서 k8s 리소스를 삭제



**2) tiller delete 명령어**

You have to uninstall 3 things to completely get rid of tiller:

1. Deployment
2. Service
3. Secret

```yaml
kubectl delete deployment -n some-namespace tiller-deploy 
kubectl delete svc -n some-namespace tiller-deploy 
kubectl delete secret -n some-namespace tiller-secret
```

Be sure to backup the secret as it store all the certificates if TLS is enabled.



##### kubernetes get pods 명령어

```
❯ kp
```

|                 NAME                 | READY | STATUS  | RESTARTS | AGE  |     IP NODE     |              NOMINATED NODE              |
| :----------------------------------: | :---: | :-----: | :------: | :--: | :-------------: | :--------------------------------------: |
| appdu-novaocean-dev-deploy-mariadb-0 |  1/1  | Running |    0     |  1m  | 192.168.194.53  | ktis-appdu04.c01-okd.cz-tb.paas.kt.co.kr |
|   backend-python-7cf7898b6f-z5ll5    |  1/1  | Running |    0     |  1m  | 192.168.190.250 | ktis-appdu03.c01-okd.cz-tb.paas.kt.co.kr |
|    tiller-deploy-6944db7bd9-8nnp7    |  1/1  | Running |    0     | 50d  | 192.168.191.177 | ktis-appdu03.c01-okd.cz-tb.paas.kt.co.kr |



#### 20. mongodb document 삭제/수정

[mongodb 접속]
1. kubectl exec -it cz-okd-dev-appdu-mediator-dev-deploy-mongodb-0 sh -n appdu
2. mongo -u 'mediatorapp' -p 'Arsenal!' --authenticationDatabase mediator
3. use mediator
4. show collections
5. db.LoginHist.find()



[document 삭제]

```
db.IpBlock.deleteOne({ "_id" : "10.220.202.145" });
```

[document 수정]

```
db.LoginHist.updateOne({"username":"tester"}, {"$set":{"failCount":0}});
```



#### 21. 개발환경 할당 프로세스

1. 작업공간 할당 (인프라)
2. 방화벽 요청
3. 앱두 작업공간 할당 (앱두 관리자) 
4. 개발환경을 구성해야 깃랩 로그인 가능



#### 22. 백신 설치 모니터링 (22.01.13 18:00~21:00)

메신저 내용 정리



- 앱두 개발: 01~02노드가 앱두 전용, 02~05노드가 개발자용 (02번 노드 공용)
- 앱두 운영: 01~02노드가 앱두 전용, 03~05노드가 개발자용



- 확실치 않지만 서로 참조하는 파드들 사이에서 기동 순서가 꼬이면 오류 발생 가능 (해당 호스트를 못 찾았다는 메세지)



```
$ oc get node | grep appdu
```

dmz-appdu01.c02-okd.cz.paas.kt.co.kr       Ready   node       202d   v1.11.0+d4cacc0

ktis-appdu01.c02-okd.cz.paas.kt.co.kr       Ready   node       337d   v1.11.0+d4cacc0

ktis-appdu02.c02-okd.cz.paas.kt.co.kr       Ready   node       337d   v1.11.0+d4cacc0

ktis-appdu03.c02-okd.cz.paas.kt.co.kr       Ready   node       337d   v1.11.0+d4cacc0

ktis-appdu04.c02-okd.cz.paas.kt.co.kr       Ready   node       337d   v1.11.0+d4cacc0

ktis-appdu05.c02-okd.cz.paas.kt.co.kr       Ready   node       337d   v1.11.0+d4cacc0 

```
$ oc describe node ktis-appdu03.c02-okd.cz.paas.kt.co.kr 
```

oc명령어로 노드 및 파드를 점검하거나 okd콘솔에 접속해서 점검하셔도 됩니다



- aptmate만 mariadb 파드가 안 뜨는 문제 발생

| 8:06:57 PM | Warning | Failed Mount | MountVolume.SetUp failed  for volume "data" : mount failed: exit status 32 Mounting command:  systemd-run Mounting arguments: --description=Kubernetes transient mount for  /var/lib/origin/openshift.local.volumes/pods/a0bc0fa0-7460-11ec-bcca-fa163ebc0c04/volumes/kubernetes.io~nfs/data  --scope -- mount -t nfs 10.220.202.124:/appdu_nas  /var/lib/origin/openshift.local.volumes/pods/a0bc0fa0-7460-11ec-bcca-fa163ebc0c04/volumes/kubernetes.io~nfs/data  Output: Running scope as unit run-13756.scope.… [See All](https://ktis-console.c02-okd.cz.paas.kt.co.kr/console/) |
| ---------- | ------- | ------------ | ------------------------------------------------------------ |
| 8:06:53 PM | Warning | Failed Mount | Unable to mount volumes for  pod "aptmate-prd-deploy-mariadb-1635372000-2kp6r_aptmate(a0bc0fa0-7460-11ec-bcca-fa163ebc0c04)":  timeout expired waiting for volumes to attach or mount for pod  "aptmate"/"aptmate-prd-deploy-mariadb-1635372000-2kp6r".  list of unmounted volumes=[data]. list of unattached volumes=[data  default-token-b2hjl] |

볼륨마운트 에러 발생

 volumes:

  \- name: data

   nfs:

​    path: /appdu_nas

​    **server: 10.220.202.124**

  \- name: default-token-b2hjl

   secret:

​    defaultMode: 420

​    secretName: default-token-b2hjl 



여기서 nas 위치가 마운트되지 않는 것 같습니다 => 어플리케이션 에러 로그가 아니고 볼륨 설정 적용이라 다른 원인으로 추정

(DB 데이터 백업용 POD)

NAS 이전 후 nas서버들은 IP가 **10.220.190.108** 이고 + cronjob yaml이 안 바뀌어 있음



http://git.appdu.kt.co.kr/aptmate/aptmate-prd-deploy/-/blob/master/devops/helm/aptmate-prd-deploy/values.yaml 

하단의 설정에서 cronjob 설정이 안 바뀌어 있었음.



http://jenkins-devops.c02-okd.cz.paas.kt.co.kr/view/aptmate/job/APTMATE-PRD-DEPLOY/43/parameters/ 

여기 파이프라인돌릴때 prd-deploy 선택하지 말라는데 이거 선택하면 원복 동작하는 듯

(아마 아스날거 그대로 가져와서 똑같이 동작하는 것으로 추정)



aptmate가 첫 운영배포다보니까 수동으로 배포한 부분이 있어서 좀 누락된게 있는거 같기도한데

다른 운영이랑 조금 다른부분이 있네요 혼자만 앱이기도 하고



의심되는 부분이

1. 일단 아까 nfsSever 설정이 10.220.202.124인점
2. 1번이 해당 파드 볼륨마운트는 아닌 것 같아서 http://git.appdu.kt.co.kr/aptmate/backend-aptmate/-/commit/74a14d53c671096fa275269a81c1c226a1b76ecd 여기 이력보면 이석환부장님이 3달전에 nas 경로 바꿔서 올렸고 빌드 및 배포는 12월에 해서 정상 반영되어야 하는데 안되어 있는게 이상해서 혹시 젠킨스에서 해당 파라미터를 선택해서 그런지 의심



10.220.202.124는 이관되기 전 nfs IP입니다. => 이관된 후의 IP는 10.220.190.108으로 변경되어야 합니다



status:

 active:

  \- kind: Job

   namespace: aptmate

   name: aptmate-prd-deploy-mariadb-1635372000

   uid: 3cd606b8-3771-11ec-97d5-fa163ebc0c04

   apiVersion: batch/v1

   resourceVersion: '212359585'

 lastScheduleTime: '2021-10-27T22:00:00Z' 



마지막 스케줄이 10월이거든요 이거 오늘작업이랑 무관하게 있었고

1. lastest 빌드 이미지로 운영 배포해보고 그래도 예전 nfs ip 바라보면
2. 아까 nfs 설정 변경하고 다시 빌드 후 운영 배포해보고
3. 그래도 문제면 더 찾아봐야할 것 같아요



1) 운영 전환 시에 SSL 셋팅해주면 https 적용

2) 사외망 오픈 건에 대해서는 dmz-router 설정해줘야 함 (template/router.yaml 변경) => 외부 접속 시 필수!!!



#### 23. mediator DB (MongoDB)에서 username 중복된 계정 확인

```
db.LoginHist.aggregate({$group: {_id: "$username", count: {$sum: 1} } }, {$match: {'count': {'$gte': 2} }});
```

{ "id" : "91001165", "count" : 3 }
{ "id" : "10135327", "count" : 2 }



![image-20220118150332624](D:\10151080\2. Appdu\0. 중요사항\6. 이미지 파일\mediator_query.PNG)



![image-20220118150332624](D:\10151080\2. Appdu\0. 중요사항\6. 이미지 파일\mediator_query2.PNG)



#### 24. 앱두 네트워크 관련

[Service]

- ktis망 => appdu-children=true
- 외부망에서 접근 => router.yaml에 dmz-router로 설정 (운영 오픈 후 사외망에서 접근 필요할 때)
- 외부 서비스로 접근 (아웃바운드) => pod를 dmz 존에 위치 (appdu-children=true 삭제)
- 외부 서비스에서 접근 (인바운드) => 가능한지...?



[pod]

- pod 네트워크 내용~~~





#### 25. 운영환경 초기화 안될 때 (nfs 정보가 없어서 초기화 불가)

먼저, 자동화구성 초기화를 먼저 해보고 되면 진행, 안되면 아래 단계 진행

운영환경 초기화 중에 **nfs 정보가 없어서** 삭제 안될 때 

1. adminer DB에서 **ad_auto_env_info** 테이블에서 먼저 구성정보 삭제
2. **ad_auto_env_containerized_db_info** 테이블에서 운영 DB 정보 삭제

여기까지 하면 운영환경 삭제됨.



+ k8s 리소스 남아있으면 helm delete... 명령어로 모두 지우면 됨.



#### 26. elasticsearch-master pod NotReady 상태로 지속되었던 이슈

[이슈 현황]

천안 운영 2번 노드에서 elasticsearch-master pod와 kibana pod가 NotReady 상태로 지속됨. (Readiness Check 실패)



[해결 방법]

##### **구글링** (https://github.com/elastic/helm-charts/issues/783)

If your running a single replica cluster add the following helm value:

```
clusterHealthCheckParams: "wait_for_status=yellow&timeout=1s"
```

Your status will never go green with a single replica cluster.

The following values should work:

```
replicas: 1
minimumMasterNodes: 1
clusterHealthCheckParams: 'wait_for_status=yellow&timeout=1s'
```



##### ClusterHealthCheckParams 값을 green에서 yellow로 변경 => 해결!!



#### 27. 앱두 템플릿, 샘플 변경 작업

o 앱두 템플릿 (template, devops 관련)

1) gitlab에서 소스 변경 후 Tag 새로 만들어주기 (base-버전)

2) 앱두포털 - 템플릿 관리 메뉴에서 새로운 Tag 버전으로 변경해주기



o 앱두 샘플 (sample, 소스 관련)

- gitlab에서 소스 변경 후 Settings - General - Advanced - Export project 메뉴에서 Generate new export



#### 28. pod 삭제 안될 때 강제 삭제하는 명령어

```
oc delete pod <pod-name> -n <namespace> --grace-period=0 --force
```



#### 29. Python 업그레이드 필요한 라이브러리 조회

```python
pip list --outdated
```



#### 30. 로컬에서 컨테이너 안으로 디렉토리 복사

```shell
> docker container cp ffmpeg-install php8-wkhtml-apm-laravel-nginx-fpm-1.20.1:/var/www/html
```



#### 31. 프로젝트 DB pod에 접속할 때 root 계정

사용자가 만든 계정의 비밀번호와 동일

ex) abc / abc1234로 생성했으면 root 계정은 root / abc1234



#### 32. cronjob 변경 시에 pod에 적용하는 방법

[yaml 파일 변경 시에 적용되는 순서]

- cronjob ~> job ~> pod (cronjob 수정하면 기존 job을 삭제해야 pod에 새로 적용됨)

- deployment ~> replicaset ~> pod

![image-20220404175151198](D:\10151080\2. Appdu\0. 중요사항\5. 업무 관련\cronjob-nodeselector.png)



#### 33. NFS 볼륨 요청 방법 (인프라 부서)

o 개발 클러스터

- 개발 클러스터는 

o 운영 클러스터



#### 34. 프로젝트 DB 백업 파일 생성하는 방법 (WSL2)

1. mysql db pod에 접속

2. /tmp 디렉터리로 이동 (cd /tmp) 

   - root 폴더는 파일 생성 권한이 없음

   - tmp 폴더는 777 권한

     ```
     $ ls -lh
     
     drwx------.   2 root root   37 Aug 12  2019 root
     drwxrwxrwt.   1 root root   27 Apr 12 01:52 tmp
     ```

3. mysqldump -uroot -p(db 비밀번호) (DB 데이터베이스명) > (sql 파일명).sql

4. 컨테이너 파드에서 로컬로 sql 파일 복사